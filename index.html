<!DOCTYPE html>
<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js fonts-loading" lang="en">
  <!--<![endif]-->
  <head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <link rel="canonical" href=""/>
    <title> - Chenliang Xu</title>
    <link rel="stylesheet" href="/css/main.css" type="text/css">
    
  </head>
  <body>
    <header class="header">
      <div class="content-wrap">
        
        <div class="logo">
          <h1>
            <a href=/>
              The Luckyrandom's blog
            </a>
        </div>
        <p class="description"> Some notes for myself </p>
        
    </header>
    <div id="content">
      <div class="content-wrap">
        

<article class="article intro">
  <header>
    <p class="date">
      <span>
         10. November 2014
      </span>
    </p>
    <h2>
      <a href="/articles/20141106-Manipulate-semantic-tree-of-R-language/"> Manipulate semantic tree of R language </a>
    </h2>
  </header>
  <section class="content">
    <p><em>This is basically a reading note on chapter
<a href="http://adv-r.had.co.nz/Computing-on-the-language.html">Non-standard evaluation of book The Advanced R</a>.</em></p>
<p>R provides a few functions that expose and manipulate the semantic
tree of R language. The simplest one is <code>quote</code>, which return the
semantic tree as&nbsp;is</p>
<pre><code class="lang-r">quote_for &lt;- quote(<span class="keyword">for</span>(x <span class="keyword">in</span> <span class="number">1</span>:<span class="number">3</span>){ s &lt;- s + x})
quote_for
</code></pre>
<pre><code>## for (x in 1:3) {
##     s &lt;- s + x
## }
</code></pre><p>It works on semantic level,
so the input must be a valid R&nbsp;expression,</p>
<pre><code class="lang-r"><span class="comment">## This will lead to an error</span>
<span class="comment">## quote(for(x in 1:3 in 2:4){ s &lt;- s + x})</span>
</code></pre>
<p>The returned result is a R language object, composed of calls and
symbols. We can get elements from the semantic&nbsp;tree,</p>
<pre><code class="lang-r">quote_for[[<span class="number">1</span>]]; quote_for[[<span class="number">2</span>]]; quote_for[[<span class="number">3</span>]]; quote_for[[<span class="number">4</span>]];
</code></pre>
<pre><code>## `for`
</code></pre><pre><code>## x
</code></pre><pre><code>## 1:3
</code></pre><pre><code>## {
##     s &lt;- s + x
## }
</code></pre><p>and even set&nbsp;elements,</p>
<pre><code class="lang-r">quote_for[[<span class="number">3</span>]] &lt;- quote(<span class="number">1</span>:<span class="number">10</span>)
quote_for
</code></pre>
<pre><code>## for (x in 1:10) {
##     s &lt;- s + x
## }
</code></pre><pre><code class="lang-r">s  &lt;- <span class="number">0</span>
eval(quote_for)
s
</code></pre>
<pre><code>## [1] 55
</code></pre><p>The function <code>substitute(expr, env)</code> substitute elements in semantic tree. Its
behavior is unnecessarily&nbsp;complex,</p>
<ul>
<li>If the argument <code>env</code> is <code>.GlobalEnv</code>, works the same as <code>quote</code>, without any&nbsp;substitute</li>
<li>If the argument <code>env</code> is not <code>.GlobalEnv</code><ul>
<li>If the argument <code>expr</code> is a promise object, get the expression slot
of the promise without any substitute. The is typically used to
capture unevaluated expression from caller&nbsp;function.</li>
<li>If the argument <code>expr</code> is not a promise object, substitute the
unevaluated semantic tree of <code>expr</code> using the bound in <code>env</code></li>
</ul>
</li>
</ul>
<p>This is a very bad design, that a function might do totally different
things depending on the running environment. Such a complex design
makes it hard to guess its&nbsp;behavior.</p>
<p>Following suggestions in book <em>Advanced R</em>, we define a few helper
functions, each of which does only one job clearly. Note the name of
functions are different from Advanced R. The suffix <code>*_s</code> means
standard evaluation, so it’s the caller’s responsibility to quote code
explicitly; <code>*_q</code> means the arguments are quoted automatically. Lisp
users may find name <code>*_q</code> familiar, similar to <code>setq</code>.</p>
<pre><code class="lang-r"><span class="comment">## The definition here may be hard to follow. Please focus on the</span>
<span class="comment">## usage explained below, instead of the ugly implementation. If you</span>
<span class="comment">## are curiouse about the implementation, please read Advaned R.</span>
substitute_q &lt;- <span class="keyword">function</span>(expr, env = emptyenv()) {
  expr &lt;- substitute(expr)
  <span class="keyword">if</span> (identical(env, globalenv())) {
    env &lt;- as.list(env)
  }
  eval(substitute(substitute(expr, env), list(expr = expr)))
}

substitute_s &lt;- <span class="keyword">function</span>(expr, env = emptyenv()) {
  call &lt;- substitute_q(substitute_q(x, env), list(x = expr))
  eval(call)
}
</code></pre>
<p><code>substitute_s</code> substitute the symbols in <code>expr</code> at lexical basis. For&nbsp;example,</p>
<pre><code class="lang-r">quote_for &lt;- quote(<span class="keyword">for</span>(x <span class="keyword">in</span> <span class="number">1</span>:<span class="number">3</span>){ s  &lt;- s + x})
substitute_s(quote_for, list(x = quote(y)))
</code></pre>
<pre><code>## for (y in 1:3) {
##     s &lt;- s + y
## }
</code></pre><p><code>substitute_q</code> works similarly, but it quote the argument <code>expr</code>
automatically, so the caller doesn’t need to quote the code and must
pass the argument <code>expr</code> lexically. It seems to be convenient, but may
cause some issue since we cannot pass the quoted code saved in a
variable to <code>substitute_q</code>.</p>
<pre><code class="lang-r">substitute_q(<span class="keyword">for</span>(x <span class="keyword">in</span> <span class="number">1</span>:<span class="number">3</span>){ s  &lt;- s + x}, list(x = quote(y)))
</code></pre>
<pre><code>## for (y in 1:3) {
##     s &lt;- s + y
## }
</code></pre><p><code>bquote</code> is similar but provides better control. It return unevaluated
semantic tree, and only substitute symbols wrapped in <code>.()</code>.</p>
<pre><code class="lang-r"><span class="comment">## The result is not meaningful. Why do I do that? Because I can.</span>
bquote(<span class="keyword">for</span>(x <span class="keyword">in</span> <span class="number">1</span>:<span class="number">3</span>){ s  &lt;- s + .(x)}, list(x = quote(y)))
</code></pre>
<pre><code>## for (x in 1:3) {
##     s &lt;- s + y
## }
</code></pre><p>Both <code>substitute_*</code> and <code>bquote</code> work on lexical basis, so there is no
guarantee that the result is semantically correct or
meaningful. Nonetheless, it is much easier and safer to manipulate R
code with those functions than manipulate R code as&nbsp;strings.</p>

    <p class="more">
      <a href="/articles/20141106-Manipulate-semantic-tree-of-R-language/">more</a>
    </p>
  </section>
     
</article>

<article class="article intro">
  <header>
    <p class="date">
      <span>
         22. July 2014
      </span>
    </p>
    <h2>
      <a href="/articles/20140722-R-library-search-path/"> R library search path </a>
    </h2>
  </header>
  <section class="content">
    <p>When ‘library()’ or ‘require()’ is called, R load packages from
library search paths, which consists of three different&nbsp;directory,</p>
<ul>
<li>‘.Library’ is a character string giving the location of the defualt
library, with default value&nbsp;“$R_HOME/library”</li>
<li>‘.Library.site’ is a character string vector giving the location of
the site libraries, with defualt value&nbsp;“$R_HOME/site-library”</li>
<li>User library paths. There is no variable corresponding to it, but it
can be get and set with function&nbsp;‘.libPaths()’</li>
</ul>
<p>R startup with the following&nbsp;steps,</p>
<ul>
<li>Set environment variables unless ‘—no-environ was given on the command line<ul>
<li>Load site environment variables from “$R_ENVIRON” or&nbsp;“$R_HOME/etc/Renviron.site”</li>
<li>Load user environment variables from “.Renviron” in the current or home&nbsp;directory </li>
</ul>
</li>
<li>Load startup profile files, containing R code. Only the ‘base’
package is loaded, when the profiles are loaded.<ul>
<li>Load site profile file from “$R_PROFILE” <span class="caps">OR</span>&nbsp;“$R_HOME/etc/Rprofile.site”</li>
<li>Load user profile “.Rprofile” from the current or home&nbsp;directory</li>
</ul>
</li>
<li>Load “.RData” unless ‘—no-restore’ or similar arguments was given on the command&nbsp;line</li>
<li>Call function ‘.First()’ if it exists. It can be defined in profile files or loaded from&nbsp;“.RData”.</li>
<li>Call function ‘.First.sys()’ provided by ‘base’ package, which load
all the packages specified by&nbsp;‘options(“defaultPackages”)’.</li>
</ul>
<h1 id="reference">Reference</h1>
<ul>
<li><a href="http://stat.ethz.ch/R-manual/R-patched/library/base/html/.libPaths.html">help(“.libPaths”)</a></li>
</ul>

    <p class="more">
      <a href="/articles/20140722-R-library-search-path/">more</a>
    </p>
  </section>
     
</article>

<article class="article intro">
  <header>
    <p class="date">
      <span>
         19. July 2014
      </span>
    </p>
    <h2>
      <a href="/articles/20140719-R-startup-mechanism/"> R startup mechanism </a>
    </h2>
  </header>
  <section class="content">
    <p>R startup with the following&nbsp;steps,</p>
<ul>
<li>Set environment variables unless ‘—no-environ was given on the command line<ul>
<li>Load site environment variables from&nbsp;“$R_HOME/etc/Renviron”</li>
<li>Load site environment variables from “$R_ENVIRON” or&nbsp;“$R_HOME/etc/Renviron.site”</li>
<li>Load user environment variables from “.Renviron” in the current or home&nbsp;directory </li>
</ul>
</li>
<li>Load startup profile files, containing R code. Only the ‘base’
package is loaded, when the profiles are loaded.<ul>
<li>Load site profile file from “$R_PROFILE” <span class="caps">OR</span>&nbsp;“$R_HOME/etc/Rprofile.site”</li>
<li>Load user profile “.Rprofile” from the current or home&nbsp;directory</li>
</ul>
</li>
<li>Load “.RData” unless ‘—no-restore’ or similar arguments was given on the command&nbsp;line</li>
<li>Call function ‘.First()’ if it exists. It can be defined in profile files or loaded from&nbsp;“.RData”.</li>
<li>Call function ‘.First.sys()’ provided by ‘base’ package, which load
all the packages specified by&nbsp;‘options(“defaultPackages”)’.</li>
</ul>
<h1 id="reference">Reference</h1>
<ul>
<li><a href="http://stat.ethz.ch/R-manual/R-patched/library/base/html/Startup.html">help(“Startup”)</a></li>
</ul>

    <p class="more">
      <a href="/articles/20140719-R-startup-mechanism/">more</a>
    </p>
  </section>
     
</article>

<article class="article intro">
  <header>
    <p class="date">
      <span>
         01. October 2012
      </span>
    </p>
    <h2>
      <a href="/articles/some-test/"> Code and stuff! </a>
    </h2>
  </header>
  <section class="content">
    <p>Syntax highlighting with <a href="http://softwaremaniacs.org/soft/highlight/en/">highlight.js</a>.
The theme used is tomorrow, you can find more themes <a href="http://jmblog.github.io/color-themes-for-highlightjs/">here</a>.</p>
<p>
    <p class="more">
      <a href="/articles/some-test/">more</a>
    </p>
  </section>
     
</article>


      </div>
    </div>
    <footer>
      <div class="content-wrap">
        
<div class="nav">
  
  <a href="/archive.html"> Archives </a>
  
  
</div>

        <section class="about">
          
        </section>
        <section class="copy">
          <p> &copy; 2014 Chenliang Xu &mdash; powerd by &nbsp;
            <a href='https://github.com/jnordberg/wintersmith'> Wintersmith </a>
          </p>
        </section>
        

      </div>
    </footer>
  </body>
</html>
