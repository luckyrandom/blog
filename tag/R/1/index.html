<!DOCTYPE html>
<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js fonts-loading" lang="en">
  <!--<![endif]-->
  <head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <link rel="canonical" href=""/>
    <title> - luckyrandom.com/blog/</title>
    <link rel="stylesheet" href="/blog/css/main.css" type="text/css">
    <link rel="stylesheet" href="/blog/highlight/styles/tomorrow.css">
    <script src="/blog/highlight/highlight.pack.js"></script>
    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="/blog/javascript/highlight-pandoc.js"></script>
    
  </head>
  <body>
    <header class="header">
      <div class="content-wrap">
        
        <div class="logo">
          <h1>
            <a href=/blog/>
              The Luckyrandom's blog
            </a>
        </div>
        <p class="description"> I enjoy thinking; I know statistics; I can code. </p>
        
    </header>
    <div id="content">
      <div class="content-wrap">
        

<article class="article intro">
  <header>
    <p class="date">
      <span>
         29. April 2015
      </span>
    </p>
    <h2>
      <a href="/blog/articles/00050-311-service/"> Big data analytics with dplyr and SQLite </a>
    </h2>
  </header>
  <section class="content">
    <style type="text/css">
div.code_chunk {
border-left: rgb(123, 218, 123);
border-left-width: thick;
border-left-style: solid;
}

pre.time {
display: block;b
padding-right: 1ex;
Background-color: rgb(123, 218, 123);
padding: 0.2em;
margin-left: 0em;
margin-bottom: 0em;
border: none;
border-radius: initial;
color: rgba(255, 255, 255, 0.75);
font-size: 0.6em;
}
</style>
<p><strong>The rmd source file is available on <a href="https://github.com/luckyrandom/blog/tree/source/contents/articles/00050-311-service/311service.Rmd">github</a>.</strong></p>
<h1 id="summary">Summary</h1>
<p>This is a long post. I put my thought about this project in the beginning, so you can skip all the&nbsp;details.</p>
<ul>
<li>In memory implementation is in general faster than database. If your data is not that big, try in memory&nbsp;implementation.</li>
<li>The dplyr wrap makes it easy to switch from one implementation to another, though it is not&nbsp;effortless.</li>
<li>Be careful with unusual values. “00:00:00” may mean&nbsp;<span class="caps">NA</span>.</li>
<li>Choose an informative&nbsp;plot.</li>
</ul>
<h1 id="introduction">Introduction</h1>
<p>The article <a href="https://plot.ly/ipython-notebooks/big-data-analytics-with-pandas-and-sqlite/#A-Large-Data-Workflow-with-Pandas">Big data analytics with Pandas and SQLite</a> on <a href="https://plot.ly/">plot.ly</a> demonstrates a large data workflow with Pandas, Python and SQLite. As suggested by <a href="https://twitter.com/hadleywickham">Hadley Wickham</a> on <a href="https://twitter.com/hadleywickham/status/586946466570047488">twitter</a>, this post reimplements it in R for comparison. It may not be a fair comparison, since reimplement is easier than original analysis. This post owes a debt of gratitude to the <a href="https://plot.ly/ipython-notebooks/big-data-analytics-with-pandas-and-sqlite/#A-Large-Data-Workflow-with-Pandas">original post</a> for its great&nbsp;analysis.</p>
<p>The data file is composed of about 9.1 million rows of data (a diiferent size from the post on plot.ly, since the size increases everyday), containing <span class="caps">NYC</span>’s 311 complaints since 2003. The data file is too large to track in git, and can be download from <a href="https://nycopendata.socrata.com/Social-Services/311-Service-Requests-from-2010-to-Present/erm2-nwe9"><span class="caps">NYC</span>’s open data portal</a>.</p>
<p>The original article performs out-of-memory aggregations with SQLite, since the dataset is too large to load into a Pandas dataframe. However, the few columns we are interested in can be loaded in memory easily. This post compares three different implementation in&nbsp;R</p>
<ul>
<li>dplyr wrap of in memory&nbsp;data.frame</li>
<li>dplyr wrap of SQLite&nbsp;database</li>
<li><span class="caps">SQL</span> command with SQLite&nbsp;database</li>
</ul>
<p>Functions from <code>dplyr</code> and pipe function <code>%&gt;%</code> are heavily used in this post. Listed below are a few references about&nbsp;them.</p>
<ul>
<li><a href="http://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html">Vignette about <code>%&gt;%</code> and <code>%T&gt;%</code></a></li>
<li><a href="http://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html">Introduction to&nbsp;dplyr</a></li>
<li><a href="http://cran.rstudio.com/web/packages/dplyr/vignettes/new-sql-backend.html">Introduction to dplyr <span class="caps">SQL</span>&nbsp;backend</a></li>
</ul>
<p>The code of the first half of post is direct translation of the Python code from the original post, and the <span class="caps">SQL</span> code is mostly copied from original post. The second half, starting from section about plot, is more or less different from the original post for two&nbsp;reasons.</p>
<p>Firstly, the original post use interactive plot heavily by <a href="https://plot.ly/">plot.ly</a>, but it’s not easy to draw active plot in R (which indeed means I’m not good at it in&nbsp;R).</p>
<p>Secondly and more importantly, I hold a different opinion about some of the plots. Although the interactive plots are cool, the information included is too dense to be useful. You can hover mouse on the plot to get detail information, but you don’t know where to hover when the plot include more than hundreds of columns or rows of data. Instead, the plots in this posts focus on top values. Also, some of the bar charts are replaced by dots plots and heat plots when they are more&nbsp;informative.</p>
<p>This post is written in <code>rmarkdown</code> and rendered by <a href="http://yihui.name/knitr/">knitr</a> and <a href="http://pandoc.org/">pandoc</a>, or can be rendered by <a href="http://rmarkdown.rstudio.com/">R Markdown v2</a>, if you prefer. The <span class="caps">CPU</span> time is measured with some special hook of knitr, and reported both as number and color of header of each chunk, with red representing long run time. Please check the source code if you are interested in the&nbsp;implementation.</p>

    <p class="more">
      <a href="/blog/articles/00050-311-service/">more</a>
    </p>
  </section>
     
</article>

<article class="article intro">
  <header>
    <p class="date">
      <span>
         10. November 2014
      </span>
    </p>
    <h2>
      <a href="/blog/articles/00040-Manipulate-semantic-tree-of-R-language/"> Manipulate semantic tree of R language </a>
    </h2>
  </header>
  <section class="content">
    <p><em>This is basically a reading note on chapter <a href="http://adv-r.had.co.nz/Computing-on-the-language.html">Non-standard evaluation of book The Advanced R</a>.</em></p>
<p>R provides a few functions that expose and manipulate the semantic tree of R language. The simplest one is <code>quote</code>, which return the semantic tree as&nbsp;is</p>
<pre class="r"><code>quote_for &lt;- quote(for(x in 1:3){ s &lt;- s + x})
quote_for</code></pre>
<pre><code>## for (x in 1:3) {
##     s &lt;- s + x
## }</code></pre>
<p>It works on semantic level, so the input must be a valid R&nbsp;expression,</p>
<pre class="r"><code>## This will lead to an error
## quote(for(x in 1:3 in 2:4){ s &lt;- s + x})</code></pre>
<p>The returned result is a R language object, composed of calls and symbols. We can get elements from the semantic&nbsp;tree,</p>
<pre class="r"><code>quote_for[[1]]; quote_for[[2]]; quote_for[[3]]; quote_for[[4]];</code></pre>
<pre><code>## `for`</code></pre>
<pre><code>## x</code></pre>
<pre><code>## 1:3</code></pre>
<pre><code>## {
##     s &lt;- s + x
## }</code></pre>
<p>and even set&nbsp;elements,</p>
<pre class="r"><code>quote_for[[3]] &lt;- quote(1:10)
quote_for</code></pre>
<pre><code>## for (x in 1:10) {
##     s &lt;- s + x
## }</code></pre>
<pre class="r"><code>s  &lt;- 0
eval(quote_for)
s</code></pre>
<pre><code>## [1] 55</code></pre>
<p>The function <code>substitute(expr, env)</code> substitute elements in semantic tree. Its behavior is unnecessarily complex, - If the argument <code>env</code> is <code>.GlobalEnv</code>, works the same as <code>quote</code>, without any substitute - If the argument <code>env</code> is not <code>.GlobalEnv</code> - If the argument <code>expr</code> is a promise object, get the expression slot of the promise without any substitute. The is typically used to capture unevaluated expression from caller function. - If the argument <code>expr</code> is not a promise object, substitute the unevaluated semantic tree of <code>expr</code> using the bound in <code>env</code></p>
<p>This is a very bad design, that a function might do totally different things depending on the running environment. Such a complex design makes it hard to guess its&nbsp;behavior.</p>
<p>Following suggestions in book <em>Advanced R</em>, we define a few helper functions, each of which does only one job clearly. Note the name of functions are different from Advanced R. The suffix <code>*_s</code> means standard evaluation, so it’s the caller’s responsibility to quote code explicitly; <code>*_q</code> means the arguments are quoted automatically. Lisp users may find name <code>*_q</code> familiar, similar to <code>setq</code>.</p>
<pre class="r"><code>## The definition here may be hard to follow. Please focus on the
## usage explained below, instead of the ugly implementation. If you
## are curiouse about the implementation, please read Advaned R.
substitute_q &lt;- function(expr, env = emptyenv()) {
  expr &lt;- substitute(expr)
  if (identical(env, globalenv())) {
    env &lt;- as.list(env)
  }
  eval(substitute(substitute(expr, env), list(expr = expr)))
}

substitute_s &lt;- function(expr, env = emptyenv()) {
  call &lt;- substitute_q(substitute_q(x, env), list(x = expr))
  eval(call)
}</code></pre>
<p><code>substitute_s</code> substitute the symbols in <code>expr</code> at lexical basis. For&nbsp;example,</p>
<pre class="r"><code>quote_for &lt;- quote(for(x in 1:3){ s  &lt;- s + x})
substitute_s(quote_for, list(x = quote(y)))</code></pre>
<pre><code>## for (y in 1:3) {
##     s &lt;- s + y
## }</code></pre>
<p><code>substitute_q</code> works similarly, but it quote the argument <code>expr</code> automatically, so the caller doesn’t need to quote the code and must pass the argument <code>expr</code> lexically. It seems to be convenient, but may cause some issue since we cannot pass the quoted code saved in a variable to <code>substitute_q</code>.</p>
<pre class="r"><code>substitute_q(for(x in 1:3){ s  &lt;- s + x}, list(x = quote(y)))</code></pre>
<pre><code>## for (y in 1:3) {
##     s &lt;- s + y
## }</code></pre>
<p><code>bquote</code> is similar but provides better control. It return unevaluated semantic tree, and only substitute symbols wrapped in <code>.()</code>.</p>
<pre class="r"><code>## The result is not meaningful. Why do I do that? Because I can.
bquote(for(x in 1:3){ s  &lt;- s + .(x)}, list(x = quote(y)))</code></pre>
<pre><code>## for (x in 1:3) {
##     s &lt;- s + y
## }</code></pre>
<p>Both <code>substitute_*</code> and <code>bquote</code> work on lexical basis, so there is no guarantee that the result is semantically correct or meaningful. Nonetheless, it is much easier and safer to manipulate R code with those functions than manipulate R code as&nbsp;strings.</p>

    <p class="more">
      <a href="/blog/articles/00040-Manipulate-semantic-tree-of-R-language/">more</a>
    </p>
  </section>
     
</article>

<article class="article intro">
  <header>
    <p class="date">
      <span>
         22. July 2014
      </span>
    </p>
    <h2>
      <a href="/blog/articles/00030-R-library-search-path/"> R library search path </a>
    </h2>
  </header>
  <section class="content">
    <p>When ‘library()’ or ‘require()’ is called, R load packages from library search paths, which consists of three different&nbsp;directory,</p>
<ul>
<li>‘.Library’ is a character string giving the location of the defualt library, with default value <code>$R_HOME/library</code></li>
<li>‘.Library.site’ is a character string vector giving the location of the site libraries, with defualt value <code>$R_HOME/site-library</code></li>
<li>User library paths. There is no variable corresponding to it, but it can be get and set with function&nbsp;‘.libPaths()’</li>
</ul>
<p>R startup with the following&nbsp;steps,</p>
<ul>
<li>Set environment variables unless ’–no-environ was given on the command&nbsp;line</li>
<li>Load site environment variables from <code>$R_ENVIRON</code> or <code>$R_HOME/etc/Renviron.site</code></li>
<li>Load user environment variables from <code>.Renviron</code> in the current or home&nbsp;directory</li>
<li>Load startup profile files, containing R code. Only the ‘base’ package is loaded, when the profiles are&nbsp;loaded.</li>
<li>Load site profile file from <code>$R_PROFILE</code> <span class="caps">OR</span> <code>$R_HOME/etc/Rprofile.site</code></li>
<li>Load user profile <code>.Rprofile</code> from the current or home&nbsp;directory</li>
<li>Load <code>.RData</code> unless ‘–no-restore’ or similar arguments was given on the command&nbsp;line</li>
<li>Call function ‘.First()’ if it exists. It can be defined in profile files or loaded from <code>.RData</code>.</li>
<li>Call function ‘.First.sys()’ provided by ‘base’ package, which load all the packages specified by&nbsp;‘options(“defaultPackages”)’.</li>
</ul>
<h1 id="reference">Reference</h1>
<ul>
<li><a href="http://stat.ethz.ch/R-manual/R-patched/library/base/html/.libPaths.html">help(“.libPaths”)</a></li>
</ul>

    <p class="more">
      <a href="/blog/articles/00030-R-library-search-path/">more</a>
    </p>
  </section>
     
</article>

<article class="article intro">
  <header>
    <p class="date">
      <span>
         19. July 2014
      </span>
    </p>
    <h2>
      <a href="/blog/articles/00020-R-startup-mechanism/"> R startup mechanism </a>
    </h2>
  </header>
  <section class="content">
    <p>R startup with the following&nbsp;steps,</p>
<ul>
<li>Set environment variables unless ’–no-environ was given on the command&nbsp;line</li>
<li>Load site environment variables from <code>$R\_HOME/etc/Renviron</code></li>
<li>Load site environment variables from <code>$R\_ENVIRON</code> or <code>$R\_HOME/etc/Renviron.site</code></li>
<li>Load user environment variables from <code>.Renviron</code> in the current or home&nbsp;directory</li>
<li>Load startup profile files, containing R code. Only the ‘base’ package is loaded, when the profiles are&nbsp;loaded.</li>
<li>Load site profile file from <code>$R\_PROFILE</code> <span class="caps">OR</span> <code>$R\_HOME/etc/Rprofile.site</code></li>
<li>Load user profile <code>.Rprofile</code> from the current or home&nbsp;directory</li>
<li>Load <code>.RData</code> unless ‘–no-restore’ or similar arguments was given on the command&nbsp;line</li>
<li>Call function ‘.First()’ if it exists. It can be defined in profile files or loaded from <code>.RData</code>.</li>
<li>Call function ‘.First.sys()’ provided by ‘base’ package, which load all the packages specified by ‘options(<code>defaultPackages</code>)’.</li>
</ul>
<h1 id="reference">Reference</h1>
<ul>
<li><a href="http://stat.ethz.ch/R-manual/R-patched/library/base/html/Startup.html">help(“Startup”)</a></li>
</ul>

    <p class="more">
      <a href="/blog/articles/00020-R-startup-mechanism/">more</a>
    </p>
  </section>
     
</article>


      </div>
    </div>
    <footer>
      <div class="content-wrap">
        
<div class="nav">
  
  <a href="/blog/archive.html"> Archives </a>
  
  
</div>

        <section class="about">
          

        </section>
        <section class="copy">
          <p> &copy; 2014 Chenliang Xu &mdash; powerd by &nbsp;
            <a href='https://github.com/jnordberg/wintersmith'> Wintersmith </a>
          </p>
        </section>
        

      </div>
    </footer>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-62238615-2', 'auto');
  ga('send', 'pageview');
</script>
  </body>
</html>
